name: Verificar Respostas - Chatbot

on:
  workflow_dispatch:
  schedule:
    # Verifica mensagens a cada 2 horas (das 8h √†s 22h BRT)
    # UTC: 11, 13, 15, 17, 19, 21, 23, 1 (pr√≥ximo dia)
    - cron: "0 11,13,15,17,19,21,23 * * *"  # 8h, 10h, 12h, 14h, 16h, 18h, 20h, 22h BRT
    - cron: "0 1 * * *"  # 22h BRT (√∫ltima verifica√ß√£o do dia)

env:
  PYTHON_VERSION: "3.11"

jobs:
  verificar-respostas:
    name: Verificar e Responder Mensagens
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          
      - name: Verificar instala√ß√£o LangChain
        run: |
          python -c "
          try:
              from langchain_groq import ChatGroq
              print('‚úì langchain-groq instalado')
          except ImportError:
              try:
                  from langchain.chat_models import ChatGroq
                  print('‚úì langchain (vers√£o antiga) instalado')
              except ImportError:
                  print('‚úó langchain-groq N√ÉO instalado')
                  import sys
                  sys.exit(1)
          
          try:
              from langchain_core.prompts import ChatPromptTemplate
              print('‚úì langchain-core instalado')
          except ImportError:
              try:
                  from langchain.prompts import ChatPromptTemplate
                  print('‚úì langchain (vers√£o antiga) instalado')
              except ImportError:
                  print('‚úó langchain-core N√ÉO instalado')
                  import sys
                  sys.exit(1)
          
          try:
              import groq
              print('‚úì groq instalado')
          except ImportError:
              print('‚úó groq N√ÉO instalado')
              import sys
              sys.exit(1)
          "

      - name: Verificar e responder mensagens
        env:
          # Configura√ß√µes de data e parcelas
          START_YEAR: "2026"
          START_MONTH: "1"
          BUSINESS_DAYS_AFTER_MONTH_START: "5"
          INSTALLMENTS: "6"
          INSTALLMENT_VALUE: "386.56"
          
          # Dados do devedor
          DEBTOR_NAME: "Samuel Cassiano de Carvalho"
          DEBTOR_CPF: "REDACTED"
          DEBTOR_EMAIL: "samuelsamuelheibr@hotmail.com"
          DEBTOR_PHONE: "+558488910528"
          
          # Configura√ß√µes gerais
          TIMEZONE: "America/Sao_Paulo"
          TEST_MODE: "false"
          MULTA_PERCENT: "2.0"
          INTEREST_MONTHLY_PERCENT: "1.0"
          GRACE_DAYS: "0"
          CURRENCY: "BRL"
          PIX_KEY: "84988910528"
          
          # Configura√ß√µes Twilio
          WHATSAPP_PROVIDER: "twilio"
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM }}
          
          # Groq para chatbot
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "üîç Verificando mensagens recebidas..."
          python verificar_respostas.py

