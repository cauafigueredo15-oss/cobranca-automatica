name: Cobrança Automática

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Executar em modo de teste?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      force_due_date:
        description: 'Forçar dia de vencimento (formato: YYYY-MM-DD). Deixe vazio para usar data atual.'
        required: false
        default: ''
        type: string
  schedule:
    # Executa diariamente às 11:00 UTC (08:00 BRT)
    # Formato: minuto hora dia mês dia-da-semana
    - cron: "0 11 * * *"

env:
  PYTHON_VERSION: "3.11"

jobs:
  run-cobranca:
    name: Executar Cobrança
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          
      - name: Verificar instalação (opcional para chatbot)
        if: always()
        run: |
          python -c "
          try:
              from langchain_groq import ChatGroq
              print('✓ langchain-groq disponível')
          except ImportError:
              print('⚠ langchain-groq não disponível (chatbot desabilitado)')
          "

      - name: Validar configuração
        env:
          NOW_OVERRIDE: ${{ github.event.inputs.force_due_date || '' }}
        run: |
          python -c "
          import sys
          import os
          from cobranca_single import Config, ConfigError
          try:
              config = Config()
              print('✓ Configuração válida')
              print(f'  Modo teste: {config.test_mode}')
              print(f'  Parcelas: {config.installments}')
              print(f'  Valor: R$ {config.installment_value}')
              if config.now_override:
                  print(f'  ⚠ Data forçada: {config.now_override}')
                  print(f'    (Simulando vencimento nesta data para testes)')
          except ConfigError as e:
              print('✗ Erro de configuração:', e)
              sys.exit(1)
          except Exception as e:
              print('✗ Erro inesperado:', e)
              sys.exit(1)
          "

      - name: Executar cobrança
        env:
          # Forçar data de vencimento (para testes)
          # Se fornecido, simula que hoje é essa data para testar envio de mensagens
          # Configurações de data e parcelas
          START_YEAR: "2026"
          START_MONTH: "1"
          BUSINESS_DAYS_AFTER_MONTH_START: "5"
          INSTALLMENTS: "6"
          INSTALLMENT_VALUE: "386.56"
          
          # Dados do devedor
          DEBTOR_NAME: "Samuel Cassiano de Carvalho"
          DEBTOR_CPF: "REDACTED"
          DEBTOR_EMAIL: "samuelsamuelheibr@hotmail.com"
          DEBTOR_PHONE: "+558488910528"
          
          # Configurações gerais
          TIMEZONE: "America/Sao_Paulo"
          TEST_MODE: ${{ github.event.inputs.test_mode || 'true' }}
          NOW_OVERRIDE: ${{ github.event.inputs.force_due_date || '' }}
          MULTA_PERCENT: "2.0"
          INTEREST_MONTHLY_PERCENT: "1.0"
          GRACE_DAYS: "0"
          CURRENCY: "BRL"
          PIX_KEY: "84988910528"
          
          # Configurações Twilio (secrets do repositório)
          WHATSAPP_PROVIDER: "twilio"
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM }}
        run: |
          if [ -n "$NOW_OVERRIDE" ]; then
            echo "⚠ ATENÇÃO: Data de vencimento forçada para $NOW_OVERRIDE"
            echo "   O sistema simulará que hoje é esta data para testar o envio."
          fi
          python cobranca_single.py

      - name: Verificar e responder mensagens recebidas
        if: always()
        env:
          # Mesmas variáveis do step anterior
          START_YEAR: "2026"
          START_MONTH: "1"
          BUSINESS_DAYS_AFTER_MONTH_START: "5"
          INSTALLMENTS: "6"
          INSTALLMENT_VALUE: "386.56"
          DEBTOR_NAME: "Samuel Cassiano de Carvalho"
          DEBTOR_CPF: "REDACTED"
          DEBTOR_EMAIL: "samuelsamuelheibr@hotmail.com"
          DEBTOR_PHONE: "+558488910528"
          TIMEZONE: "America/Sao_Paulo"
          TEST_MODE: ${{ github.event.inputs.test_mode || 'true' }}
          MULTA_PERCENT: "2.0"
          INTEREST_MONTHLY_PERCENT: "1.0"
          GRACE_DAYS: "0"
          CURRENCY: "BRL"
          PIX_KEY: "84988910528"
          WHATSAPP_PROVIDER: "twilio"
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM: ${{ secrets.TWILIO_FROM }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "Verificando mensagens recebidas nas últimas 24 horas..."
          python verificar_respostas.py

      - name: Verificar logs
        if: always()
        run: |
          echo "Workflow concluído. Verifique os logs acima para detalhes."
